<project name="gdx-bullet-extras-swig-gen" basedir="." default="all">

	<property name="dir.out" location="${basedir}/../swig-src/extras/" />

	<target name="clean">
		<echo message="Deleting previously generated files in ${dir.out}" level="info" />
		
		<mkdir dir="${dir.out}" />
		<delete>
			<fileset dir="${dir.out}" includes="**/*" />
		</delete>
	</target>

	<target name="gen">

		<mkdir dir="${dir.out}/com/badlogic/gdx/physics/bullet/extras" />
		
		<echo message="Swigging" level="info" />

		<exec executable="swig">
			<arg value="-java" />
			<arg value="-c++" />
			<arg value="-fvirtual" />
			<arg value="-package" />
			<arg value="com.badlogic.gdx.physics.bullet.extras" />
			<arg value="-I${basedir}/../src/bullet" />
			<arg value="-I${basedir}/../src/custom" />
			<arg value="-I${basedir}/../src/extras/serialize" />
			<!-- Disable Bullet profiling -->
			<arg value="-DBT_NO_PROFILE" />
			<arg value="-outdir" />
			<arg value="${dir.out}/com/badlogic/gdx/physics/bullet/extras" />
			<arg value="-o" />
			<arg value="${dir.out}/extras_wrap.cpp" />
			<arg value="${basedir}/extras/gdxExtras.i" />

		</exec>
	</target>

	<target name="fix_casts">

		<echo message="Replacing director dynamic_cast with C-style casts to avoid RTTI" level="info" />
		<replaceregexp file="${dir.out}/extras_wrap.cpp" flags="g">
			<regexp pattern="(SwigDirector_[\w]+) \*director = dynamic_cast&lt;(SwigDirector_[\w]+ \*)&gt;\(obj\);" />
			<substitution expression="\1 *director = (\2)(obj);" />
		</replaceregexp>

	</target>
	
	<target name="remove_weak_global">
		<echo message="Remove weak_global" level="info" />
		<replace file="${dir.out}/extras_wrap.cpp"
		    token="weak_global_ = weak_global || !mem_own;"
		    value="weak_global_ = !mem_own;" />
	</target>

	<target name="all" depends="clean,gen,fix_casts,remove_weak_global">
		<echo message="Wrapper files generated, now rebuild the gdx-bullet project." level="info" />
	</target>
</project>
